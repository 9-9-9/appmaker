<polymer-element name="ceci-audio" attributes="loop source speed label value tapecolor volume"
 extends="ceci-element"
  volume="0.5"
  loop="false"
  source="http://soundjax.com/reddo/21812%5Edog_bark_x.mp3"
  tapecolor="#2181cb"
  label="Play"
  speed="1.0">
  <ceci-definition>
    {
      "tags": ["sound", "audio", "music"],
      "thumbnail": "./thumbnail.png",
      "description": "Plays an audio clip using a URL or data-uri as input.",
      "name": "Audio Clip",
      "broadcasts": {},
      "listeners": {
        "play": {
          "description": "Play the audio clip.",
          "label": "Play",
          "default": true
        },
        "pause": {
          "description": "Pause the audio clip.",
          "label": "Pause"
        },
        "stopsound": {
          "description": "Stop the audio clip.",
          "label": "Stop"
        }
      },
      "attributes": {
        "source": {
          "label": "Audio Source URL",
          "description": "The URL for the sound clip you want to play.",
          "editable": "text",
          "listener": true
        },
        "volume": {
          "label": "Volume",
          "description": "How loud do you want it to be?",
          "editable": "range",
          "step" : ".01",
          "min" : 0,
          "max" : 1
        },
        "loop": {
          "label": "Loop",
          "description": "Loop the audio clip when it finishes.",
          "editable": "boolean"
        },
        "speed": {
          "label": "Playback speed",
          "description": "1 for normal speed, 2 for double speed.",
          "editable": "range",
          "step" : ".01",
          "min" : ".5",
          "max" : "4"
        },
        "label": {
          "label": "Tape Label",
          "description": "Text shown on the tape.",
          "editable": "text"
        },
        "tapecolor": {
          "label": "Tape Color",
          "description": "What's your favorite?",
          "editable": "color"
        }
      }
    }
  </ceci-definition>
  <template>
    <link rel="stylesheet" href="component.css"></link>
    <div id="wrapper" on-ceci-pressdown="{{play}}" class="wrapper">
      <div class="label">
        <div class="text">{{label}}</div>
      </div>
      <div class="circles">
        <div class="circle left"></div>
        <div class="circle right"></div>
      </div>
    </div>
    <audio id="sound" src="sounds/snare.mp3" preload="auto"></audio>
    <shadow></shadow>
  </template>
  <script>
    Polymer('ceci-audio', {
      ready: function() {
        this.super();
        var that = this;
        this.$.sound.addEventListener("ended",function(){
          that.stopsound();
          if(that.loop === "true"){
            that.play();
          }
        });
      },
      state : "stopped",
      stopsound : function(){
        this.$.sound.pause();
        this.$.sound.currentTime = 0;
        this.$.wrapper.classList.remove("playing");
        this.state = "stopped";
      },
      play: function() {
        var readyState = this.$.sound.readyState;
        if(readyState != 0) {
          this.$.wrapper.classList.add("playing");
          if(this.state == "paused") {
            this.$.sound.play();
            this.state = "playing";
          } else {
            this.$.sound.pause();
            this.$.sound.currentTime = 0;
            this.$.sound.play();
            this.state = "playing";
          }
        } else {
          this.$.wrapper.classList.remove("cantplay");
          this.$.wrapper.offsetWidth = this.$.wrapper.offsetWidth;
          this.$.wrapper.classList.add("cantplay");
        }
      },
      pause : function(){
        this.$.wrapper.classList.remove("playing");
        this.$.sound.pause();
        this.state = "paused";
      },
      sourceChanged: function(oldValue, newValue) {
        this.$.sound.src = newValue;
      },
      setSpeed: function(channel, value) {
        this.speedChanged(this.$.sound.playbackRate || 1, value);
      },
      volumeChanged : function(oldValue, newValue){
        this.$.sound.volume = newValue;
      },
      tapecolorChanged: function (oldValue, newValue) {
        this.$.wrapper.style.background = newValue;
      },
      speedChanged: function(oldValue, newValue) {
        try  {
          var f = parseFloat(newValue);
          if (f) {
            this.$.sound.playbackRate = parseFloat(newValue);
          }
        } catch (e) {}
      }
    });
  </script>
</polymer-element>
