<polymer-element
  name="user-state"
  attribute="user"
  >
  <template>
    <style>
      :host {
        display: inline;
        color: white;
        position: relative;
      }
      button {
        height: 26px;
        width: 102px;
        font-size: 16px;
        cursor: pointer;
        background-color: #e81e1e;
        margin: 12px 12px 0px 0px;
        border-radius: 2px;
      }
      :host #email {
        cursor: pointer;
        margin-left: 0.5em;
      }
      :host #email:hover {
        text-decoration: underline;
      }
      :host #email:before {
        content: "\2193\0020";
      }
      :host #signout {
        float: left;
      }
      .menubutton {
        display: inline-block;
      }
      .menu {
        z-index: 12000;
        padding: .3em;
        border-color: #444;
        background-color: #222;
        /*width: 10em;*/
        position: absolute;
        left: 0;
        top: 0;
        height: 10em;
        float: left;
      }
      .hidden {
        display: none;
      }
      :host #myapps {
        display: block;
        float: left;
      }
      :host #myappsheading {
        float: left;
        clear: both;
        width: 100%;
        text-align: left;
      }
      :host #myapps {
        margin: 0;
        padding: 0;
      }
      :host #myapps li {
        float: left;
        clear: both;
        margin-top: 0;
        padding: 0;
        padding-left: 0.5em;
      }
      :host #myapps li {
        list-style-type: none;
        margin: 0;
        font-size: small;
        padding: 0;
      }
      :host #myapps .applink {
        text-align: left;
        font-size: small;
        text-decoration: underline;
        border: 0;
        background-color: transparent;
        color: white;
        padding: 0;
        margin: 0;
      }
    </style>
    <button id="signin" class="btn-std btn-md {{hidden: user.state == 'signedin'}}" on-click="{{signinClick}}">login</button>
    <div class="menubutton" on-mousedown="{{showMenu}}">
      <span id="email" class="{{hidden: user.state == 'signedout'}}">{{user.email}}</span>
      <div class="menu hidden" on-exit="{{hideMenu}}">
        <button id="signout" class="btn-std btn-md {{hidden: user.state == 'signedout'}}" on-click="{{signoutClick}}">logout</button>
        <span id="myappsheading">My apps</span>
        <ul id="myapps">
        </ul>
      </div>
    </div>
  </template>
  <script>
  (function() {
    var user = {
      email: '',
      state: 'signedout'
    };

    Polymer.require('user-state-driver', ['jquery', 'persona'],
      // this is done via require because it needs persona loaded to
      // be able to call navigator.id stuff

      function(jquery, persona) {
        navigator.id.watch({
          onlogin: function(assertion) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/persona/verify", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.addEventListener("loadend", function(e) {
              var data = JSON.parse(this.responseText);
              if (data && data.status === "okay") {
                console.log("You have been logged in as: " + data.email);
                document.dispatchEvent(new CustomEvent('user-state', {
                  detail: {'state': 'signedin', 'email': data.email}
                }));
              }
            }, false);

            xhr.send(JSON.stringify({
              assertion: assertion
            }));
          },
          onlogout: function() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/persona/logout", true);
            xhr.addEventListener("loadend", function(e) {
              document.dispatchEvent(
                new CustomEvent('user-state', {
                  detail: {'state': 'signedout', 'email': ''}
                })
              );
            });
            xhr.send();
          }
        });
      });

      Polymer('user-state', {
        user: user,
        ready: function() {
          var that = this;
          document.addEventListener('user-state', function (event) {
            that.user.state = event.detail.state;
            that.user.email = event.detail.email;
            if (that.user.state == 'signedin') {
              that.refreshUserState();
            }
          });
        },

        signinClick: function() {
          navigator.id.request();
        },
        signoutClick: function() {
          navigator.id.logout();
        },
        attributeChangedCallback: function(attributeName) {
          if (attributeName == 'user') {
            this.refreshUserState();
          }
        },
        showMenu: function() {
          console.log('showing menu');
          var self = this;
          var menu = this.shadowRoot.querySelector(".menu");
          menu.classList.remove('hidden');
          menu.addEventListener("mouseleave", function() {
            menu.classList.add('hidden');
          });
        },
        refreshUserState: function() {
          // go to the server and find out what the user's apps are.
          var myApps = this.shadowRoot.querySelector("#myapps");
          $.getJSON("/api/myapps", function(data) {
            var items = [];
            $.each(data.apps, function(key, val) {
              var app = document.createElement('li');
              var link = document.createElement('button');
              link.id = key;
              link.textContent = val;
              link.setAttribute('class', 'applink');
              link.addEventListener('click', function() {
                alert('loading app called: ' + val);
                // openApp(val);
              });
              app.appendChild(link);
              myApps.appendChild(app);
            });
          });
        }
      });
  })();
  </script>
</polymer-element>
