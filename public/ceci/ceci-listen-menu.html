<polymer-element name="ceci-listen-menu">
  <template>
    <div on-mouseenter="{{showMenu}}" on-mouseleave="{{hideMenu}}" class="channel-menu-wrapper" id="channelMenuWrapper">
      <div id="listenMenu" class="subscription-menu channel-menu">
        <div class="hover-helper"></div>
        <div class="channel-option subscription-option option-template">
          <div class="color-ui">
            <div name="blue"      color="blue"    class="color" data-channel="blue"></div>
            <div name="green"     color="green"   class="color" data-channel="green"></div>
            <div name="yellow"    color="yellow"  class="color" data-channel="yellow"></div>
            <div name="orange"    color="orange"  class="color" data-channel="orange"></div>
            <div name="red"       color="red"     class="color" data-channel="red"></div>
            <div name="pink"      color="pink"    class="color" data-channel="pink"></div>
            <div name="purple"    color="purple"  class="color" data-channel="purple"></div>
            <div name="false"     color="false"   class="color" data-channel=""></div>
          </div>
          <label><span class="channel-name"></span><div color="blue" class="chosen-color"></div></label>
        </div>
      </div>
    </div>
  </template>
  <script>
    (function(){
      Polymer('ceci-listen-menu', {
        showMenu : function() {
          this.$.listenMenu.style.display = "block";
          this.$.listenMenu.classList.add("menu-in");
          var height = this.$.listenMenu.offsetHeight;
          this.$.listenMenu.style.marginTop = -1 * (height/2) + "px";
        },
        hideMenu : function() {
          this.$.listenMenu.style.display = "none";
        },
        enteredView: function () {
          var that = this;
          this.component = this.parentNode.host;
          this.buildMenu();
        },
        buildMenu: function() {
          var that = this;
          var broadcastElements = this.component.querySelectorAll("ceci-listen");

          Array.prototype.forEach.call(broadcastElements, function(el,index){
            var channelTemplate = that.shadowRoot.querySelector(".option-template");
            var channelOption = channelTemplate.cloneNode(true);
            channelOption.classList.remove("option-template");
            channelOption.querySelector(".channel-name").innerHTML = el.for;
            that.$.listenMenu.appendChild(channelOption);
            var listenFor = el.for;
            var on = el.on;

            channelOption.querySelector("label").addEventListener('click', function(el) {
              this.style.display = "none";
              var colorMenu = this.parentNode.querySelector(".color-ui");
              colorMenu.style.display = "block";
            }, false);

            var colorOptions = channelOption.querySelectorAll(".color-ui .color");

            Array.prototype.forEach.call(colorOptions, function(el){
              el.addEventListener("click",function(el) {
                 var color = this.getAttribute("color");
                 channelOption.querySelector("label").style.display = "block";
                 channelOption.querySelector("label .chosen-color").setAttribute("color",color);
                 channelOption.querySelector(".color-ui").style.display = "none";
                 var channelLine = that.component.impl.querySelector("ceci-listen-vis .channel[for="+listenFor+"]");
                 channelLine.setAttribute("color",color);
                 var broadcastElement = that.component.querySelector("ceci-listen[for="+listenFor+"]");
                 broadcastElement.on = color;
               });
            });
        });
        }
      });
    })();
  </script>
</polymer-element>
