<polymer-element name="ceci-listen-menu">
  <template>
    <div on-mouseenter="{{showMenu}}" on-mouseleave="{{hideMenu}}" class="channel-menu-wrapper" id="channelMenuWrapper">
      <div id="listenMenu" class="subscription-menu channel-menu">
        <div class="hover-helper"></div>
        <div class="channel-option subscription-option option-template">
          <div class="color-ui">
            <div name="blue"      color="blue"    class="color" data-channel="blue"></div>
            <div name="green"     color="green"   class="color" data-channel="green"></div>
            <div name="yellow"    color="yellow"  class="color" data-channel="yellow"></div>
            <div name="orange"    color="orange"  class="color" data-channel="orange"></div>
            <div name="red"       color="red"     class="color" data-channel="red"></div>
            <div name="pink"      color="pink"    class="color" data-channel="pink"></div>
            <div name="purple"    color="purple"  class="color" data-channel="purple"></div>
            <div name="false"     color="false"   class="color" data-channel=""></div>
          </div>
          <label><span class="channel-name"></span><div color="blue" class="chosen-color"></div></label>
        </div>
      </div>
    </div>
  </template>
  <script>
    (function(){
      Polymer('ceci-listen-menu', {
        showMenu : function() {
          if(this.component.querySelectorAll("ceci-listen").length > 0) {
            this.$.listenMenu.style.display = "block";
            this.$.listenMenu.classList.add("menu-in");
            var height = this.$.listenMenu.offsetHeight;
            this.$.listenMenu.style.marginTop = -1 * (height/2) + "px";
          }
        },
        hideMenu : function() {
          this.$.listenMenu.style.display = "none";
        },
        enteredView: function () {
          var that = this;
          this.component = that.parentNode.host;
          this.buildMenu();
        },
        buildMenu: function() {
          var that = this;
          var broadcastElements = this.component.querySelectorAll("ceci-listen");
          var listeners =this.component.listeners;

          for (var key in listeners) {
            if (listeners.hasOwnProperty(key)) {

              var channelTemplate = that.shadowRoot.querySelector(".option-template");
              var channelOption = channelTemplate.cloneNode(true);

              channelOption.classList.remove("option-template");

              channelOption.querySelector(".channel-name").textContent = listeners[key].name;

              that.$.listenMenu.appendChild(channelOption);
              var listenFor = listeners[key].name;

              channelOption.setAttribute("for",listenFor);

              var on = "blue";

              channelOption.querySelector("label").addEventListener('click', function(el) {
                this.style.display = "none";
                var colorMenu = this.parentNode.querySelector(".color-ui");
                colorMenu.style.display = "block";
              }, false);

              var colorOptions = channelOption.querySelectorAll(".color-ui .color");


              Array.prototype.forEach.call(colorOptions, function(el){

                el.addEventListener("click",function(el) {
                   var channelOption = this.parentNode.parentNode;
                   var listenFor = channelOption.getAttribute("for");
                   var color = this.getAttribute("color");
                   channelOption.querySelector("label").style.display = "block";
                   channelOption.querySelector("label .chosen-color").setAttribute("color",color);
                   channelOption.querySelector(".color-ui").style.display = "none";

                   // var channelLine = that.component.impl.querySelector("ceci-listen-vis .channel[for="+listenFor+"]");

                   //Try to grab the associated ceci-listen element
                   var listenerEl = that.component.impl.querySelector("ceci-listen[for="+listenFor+"]");



                   if (color == "false"){
                      if (listenerEl){
                        listenerEl.parentNode.removeChild(listenerEl)
                        // that.component.impl.removeChild(listenerEl);
                      }
                   } else {
                     // If it exists
                     if (listenerEl){
                       listenerEl.setAttribute("on",color);
                     } else {
                       var newListener = document.createElement("ceci-listen");
                       newListener.setAttribute("on",color);
                       newListener.setAttribute("for",listenFor);
                       console.log("Adding new ceci-listener");
                       that.component.appendChild(newListener);
                     }

                   }





                   // also, we have to notify the VIS to update itself there big guy!
                   // with every change, it must update T'ISELF!




                   //if it just got disabled


                 });
              });

          }
        }

        }
      });
    })();
  </script>
</polymer-element>
