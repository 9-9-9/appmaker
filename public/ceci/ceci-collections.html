<polymer-element name="ceci-collections">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <content></content>
  </template>
  <script>
    Polymer('ceci-collections', {
      attached: function() {
        var savedData = {};
        var savedSchema = {};
        var self = this;
        if (this.textContent !== "") {
          try {
            savedSchema = JSON.parse(this.textContent);
          } catch (e) {
            console.error("Error parsing saved schema:", e);
          }
        } else {
          this.textContent = "{}";
        }
        self.schema = savedSchema;
        try {
          savedData = JSON.parse(sessionStorage.getItem("ceci-collections"));
        } catch (e) {
          console.error("Error parsing saved data:", e);
        }
        self.data = savedData || {};
      },
      kinds: ["Number", "Toggle", "Text", "Name", "Address", "HttpUrl", "Color", "Image"],
      schema: {},
      data: {},
      addCollection: function(name) {
        if (this.schema[name]) {
          return;
        }
        this.schema[name] = {};
        this.textContent = JSON.stringify(this.schema);
        var detail = {
          added: name
        };
        this.fire("collectionchange", detail);
      },
      removeCollection: function(name) {
        if (!this.schema[name]) {
          return;
        }
        delete this.schema[name];
        this.textContent = JSON.stringify(this.schema);
        var detail = {
          removed: name
        };
        this.fire("collectionchange", detail);
      },
      addField: function(collection, name, field) {
        if (!this.schema[collection]) {
          this.addCollection(collection);
        }
        var removed = this.schema[collection][name];
        this.schema[collection][name] = field || {};
        this.textContent = JSON.stringify(this.schema);
        var detail = {
          collection: collection,
          field: name,
          added: this.schema[collection][name]
        };
        if (removed) {
          detail.removed = removed;
        }
        this.fire("fieldchange", detail);
      },
      removeField: function(collection, name) {
        if (!this.schema[collection] || !this.schema[collection][name]) {
          return;
        }
        var removed = this.schema[collection][name];
        delete this.schema[collection][name];
        this.textContent = JSON.stringify(this.schema);
        var detail = {
          collection: collection,
          field: name,
          removed: removed
        };
        this.fire("fieldchange", detail);
      },
      addItem: function(collection, item) {
        if (!this.schema[collection]) {
          this.addCollection(collection);
        }
        if (!this.data[collection]) {
          this.data[collection] = [];
        }
        this.data[collection].push(item);
        var detail = {
          collection: collection,
          added: item
        };
        this.fire("itemchanged", detail);
      },
      removeItem: function(collection, index) {
        if (!this.data[collection] || !this.data[collection][index]) {
          return;
        }
        var removed = this.data[collection][index];
        if (!removed) {
          return;
        }
        this.data[collection].splice(index, 1);
        var detail = {
          collection: collection,
          removed: removed
        };
        this.fire("itemchanged", detail);
      },
      saveData: function() {
        sessionStorage.setItem("ceci-collections", JSON.stringify(this.data));
      }
    });
  </script>
</polymer-element>
