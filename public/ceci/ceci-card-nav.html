<polymer-element name="ceci-card-nav">

  <template>

    <div class="cards" id="cards">
      <div class="card-list" id="cardList"></div>
      <div on-click="{{addCard}}" class="add-card"></div>
    </div>


  </template>

  <script>
    Polymer('ceci-card-nav', {
      app : document.querySelector("ceci-app"),
      checked : false,
      ready: function() {
        var t = this;

        this.app.addEventListener('cardShown', function(data){
          t.buildTabs();
        });

        this.app.addEventListener('ready', function (e) {
          t.buildTabs();
        }, false);

        this.buildTabs();
      },
      highlightTab : function(card){
        //Figure out that index of the visible card
        var highlightIndex;
        var list = this.app.querySelectorAll("ceci-card") || [];
        for(var i = 0; i < list.length; i++ ){
          if(list[i].getAttribute("visible") == "true"){
            highlightIndex = i;
          }
        }
        //Highlight the corresponding tab
        var tabList = this.$.cardList.querySelectorAll('.card') || [];
        for(var j = 0; j < tabList.length; j++ ){
          tabList[j].classList.remove("selected");
          if(j == (highlightIndex)){
            tabList[j].classList.add("selected");
          }
        }
      },
      addCardTab : function(index, card){
        var t = this;
        var newthumb = document.createElement("div");
        newthumb.innerHTML = "<span class='card-name'>Page " + index + "</span><a title='Delete this card' href='#' class='delete-card'></a>";
        newthumb.classList.add("card");
        newthumb.onclick = function() {
          card.show();
        };
        newthumb.querySelector("a").onclick = function() {
          t.app.removeCard(index-1);
        };
        this.$.cardList.appendChild(newthumb);
      },
      buildTabs : function() {
        //Nuke all existing tabs
        var tabList = this.$.cardList.querySelectorAll(".card");
        if(tabList.length > 0){
          for(var i = 0; i < tabList.length; i++ ){
            this.$.cardList.removeChild(tabList[i]);
          }
        }
        //Add tabs for all pages
        var existingCards = this.app.querySelectorAll('ceci-card');
        if(existingCards.length > 0){
          for(var j = 0; j < existingCards.length; j++ ){
            var c = existingCards[j];
            this.addCardTab(j+1,c);
          }
        }
        this.highlightTab();
      },
      addCard : function() {
       this.app.addCard();
      }
    });
  </script>

</polymer-element>
