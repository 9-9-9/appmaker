<polymer-element name="ceci-element-base">
  <template>
    <content></content>
  </template>
  <script>
    (function () {
      var defaultChannel = 'blue';

      Polymer('ceci-element-base', {
        ready: function () {
          this.initCeci();
        },
        broadcast: function (name, data) {
          var broadcastElement = this.querySelector('ceci-broadcast[from="' + name + '"]');
          if (broadcastElement) {
            var broadcastDetails = { channelName : broadcastElement.on, from : name};
            broadcastElement.fire(data);
          }
        },
        showContainingCard: function () {
          var potentialCard = this.parentNode;

          while (potentialCard && potentialCard.localName !== 'ceci-card') {
            potentialCard = potentialCard.parentNode;
          }

          if (potentialCard) {
            potentialCard.show();
          }
        },
        setListener: function (name, channel) {
          var entry = this.ceci.listeners[name];

          if (entry) {
            var forAttribute = entry.attribute ? 'set_' + name : name;
            var listener = this.querySelector('ceci-listen[for="' + forAttribute + '"]');
            if (!listener) {
              listener = document.createElement('ceci-listen');
              this.appendChild(listener);
            }

            listener.setAttribute('on', channel);
            listener.setAttribute('for', forAttribute);
          }
          else {
            console.error('No listener definition found for "' + name + '".')
          }
        },
        setBroadcast: function (name, channel) {
          var entry = this.ceci.broadcasts[name];

          if (entry) {
            var broadcast = this.querySelector('ceci-broadcast[from="' + name + '"]');
            if (!broadcast) {
              broadcast = document.createElement('ceci-broadcast');
              this.appendChild(broadcast);
            }

            broadcast.setAttribute('on', channel);
            broadcast.setAttribute('from', name);
          }
          else {
            console.error('No broadcast definition found for "' + name + '".')
          }
        },
        removeListener: function (name) {
          var listen = this.querySelector('ceci-listen[for="' + name + '"]');
          if (listen) {
            this.removeChild(listen);
          }
        },
        removeBroadcast: function (name) {
          var broadcast = this.querySelector('ceci-broadcast[from="' + name + '"]');
          if (broadcast) {
            this.removeChild(broadcast);
          }
        },
        _processDefinition: function () {
          var xmlDefinition = this.shadowRoot.querySelector('ceci-definition');

          if (!xmlDefinition) {
            return null;
          }
          var definitionConstituents = {broadcast: [], listener: [], editable: []};

          Object.keys(definitionConstituents).forEach(function (key) {
            var container = xmlDefinition.querySelector('ceci-' + key + '-definitions');
            if (container) {
              Array.prototype.forEach.call(container.querySelectorAll('ceci-' + key + '-definition'), function (definitionElement) {
                var entry = {};
                Array.prototype.forEach.call(definitionElement.attributes, function (attribute) {
                  entry[attribute.name] = attribute.value;
                });
                definitionConstituents[key].push(entry);
              });
            }
          });

          return definitionConstituents;
        },
        initCeci: function () {
          var that = this;

          this.ceci = {
            broadcasts: {},
            listeners: {},
            editables: {}
          };

          var ceciDefinition = this._processDefinition();

          if (!ceciDefinition) {
            console.error('Ceci definition required for ' + this.localName);
            return;
          }

          function processListeners () {
            ceciDefinition.listener.forEach(function (listenerDefinition) {
              var listenerName = '';
              if (listenerDefinition['function'] || listenerDefinition['attribute']) {
                if (listenerDefinition['attribute']) {
                  that['set_' + listenerDefinition['attribute']] = function (value) {
                    that[listenerDefinition['attribute']] = value;
                  };
                  listenerName = listenerDefinition['attribute'];
                }
                else {
                  listenerName = listenerDefinition['function'];
                }

                that.ceci.listeners[listenerName] = listenerDefinition;

                if (!!listenerDefinition['default']) {
                  that.setListener(listenerName, defaultChannel);
                }
              }
              else {
                console.error('Definition for listener in ' + that.localName + ' is incomplete.');
              }
            });
          }

          function processBroadcasts () {
            ceciDefinition.broadcast.forEach(function (broadcastDefinition) {
              if (broadcastDefinition.name) {
                that.ceci.broadcasts[broadcastDefinition.name] = broadcastDefinition;

                if (!!broadcastDefinition['default']) {
                  that.setBroadcast(broadcastDefinition.name, defaultChannel);
                }
              }
              else {
                console.error('Definition for broadcast in ' + that.localName + ' is incomplete.');
              }
            });
          }

          function processEditables () {
            ceciDefinition.editable.forEach(function (editableDefinition) {
              if (editableDefinition.attribute) {
                that.ceci.editables[editableDefinition.attribute] = editableDefinition;
              }
              else {
                console.error('Definition for broadcast in ' + that.localName + ' is incomplete.');
              }
            });
          }

          var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              Array.prototype.forEach.call(mutation.addedNodes, function (addedNode) {
                var existingNodes = [];

                if (addedNode.localName === 'ceci-listen') {
                  existingNodes = that.querySelectorAll('ceci-listen[for="' + addedNode.getAttribute('for') + '"]');
                }

                if (addedNode.localName === 'ceci-broadcast') {
                  existingNodes = that.querySelectorAll('ceci-broadcast[from="' + addedNode.getAttribute('from') + '"]');
                }

                Array.prototype.forEach.call(existingNodes, function (existingNode) {
                  if (existingNode !== addedNode) {
                    that.removeChild(existingNode);
                  }
                });

              });
            });
          });

          observer.observe(this, {childList: true});

          processEditables();
          processBroadcasts();
          processListeners();
        }
      });
    })();
  </script>
</polymer-element>
